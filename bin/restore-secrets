#!/usr/bin/env bash
set -euo pipefail

ARCHIVE="${1:?Usage: restore-secrets path/to/keys-YYYYMMDD.tar.gz.age}"

TMP="$(mktemp -d)"
trap 'rm -rf "$TMP"' EXIT

age -d "$ARCHIVE" | tar -xz -C "$TMP"

# GPG restore
if command -v gpg >/dev/null 2>&1 && [[ -f "$TMP/gpg/secret-keys.asc" ]]; then
  gpg --import "$TMP/gpg/public-keys.asc" 2>/dev/null || true
  gpg --import "$TMP/gpg/secret-keys.asc"
  [[ -f "$TMP/gpg/ownertrust.txt" ]] && gpg --import-ownertrust "$TMP/gpg/ownertrust.txt" || true
fi

# SSH restore
if [[ -d "$TMP/ssh" ]]; then
  mkdir -p "$HOME/.ssh"
  rsync -a "$TMP/ssh/" "$HOME/.ssh/"
  chmod 700 "$HOME/.ssh"
  chmod 600 "$HOME/.ssh"/id_* 2>/dev/null || true
  chmod 644 "$HOME/.ssh"/*.pub 2>/dev/null || true
fi

# AGE restore
if [[ -d "$TMP/age" ]]; then
  mkdir -p "$HOME/.config/age"
  rsync -a "$TMP/age/" "$HOME/.config/age/"
  chmod 700 "$HOME/.config/age"
  chmod 600 "$HOME/.config/age"/* 2>/dev/null || true
fi

# Skate restore
if command -v skate >/dev/null 2>&1 && [[ -f "$TMP/skate/skate.jsonl" ]]; then
  python3 - "$TMP" <<'PY'
import base64, json, subprocess, sys, pathlib
tmp = pathlib.Path(sys.argv[1])
path = tmp / "skate" / "skate.jsonl"
for line in path.read_text().splitlines():
  rec = json.loads(line)
  val = base64.b64decode(rec["b64"])
  subprocess.check_call(["skate","set",f'{rec["key"]}@{rec["db"]}'], input=val)
PY
fi

# Oh-My-Zsh custom configs restore
if [[ -d "$TMP/omz/custom" ]]; then
  echo "Restoring Oh-My-Zsh custom configs..."
  mkdir -p "$HOME/.oh-my-zsh/custom"
  rsync -a "$TMP/omz/custom/" "$HOME/.oh-my-zsh/custom/"
fi

echo "Restore complete."

